# 🛡️ 安全なデプロイメントガイド

## 概要
このガイドは、GitHubへのプッシュやVercelへのデプロイで発生するエラーを防ぐための仕組みを提供します。

## 🚨 よくあるエラーと対策

### 1. package-lock.json関連のエラー
**原因**: `package.json`と`package-lock.json`の不一致
**対策**: 
- `package.json`を変更したら必ず`npm install`を実行
- `package-lock.json`も一緒にコミット

### 2. TypeScriptコンパイルエラー
**原因**: 型エラーや構文エラー
**対策**: 
- プッシュ前に`npx tsc --noEmit`を実行
- VSCodeの問題タブでエラーを確認

### 3. ビルドエラー
**原因**: インポートエラー、依存関係の問題
**対策**: 
- ローカルで`npm run build`を必ず実行
- 使用していない依存関係は削除

## 🛠️ 自動化ツール

### 1. デプロイ前チェックスクリプト
```bash
# 実行方法
./scripts/pre-deploy-check.sh
```

**チェック内容**:
- Node.jsバージョン
- package-lock.jsonの同期
- 環境変数の設定
- TypeScriptコンパイル
- ESLint
- ビルドテスト
- 未使用の依存関係
- Gitステータス

### 2. 安全なデプロイスクリプト
```bash
# 実行方法
./scripts/safe-deploy.sh
```

**実行内容**:
1. デプロイ前チェックを自動実行
2. ブランチの確認
3. リモートとの同期確認
4. 必要に応じてpackage-lock.jsonを更新
5. 最終ビルドテスト
6. 安全なGit操作
7. デプロイ結果の確認方法を表示

## 📋 手動チェックリスト

### 開発前
- [ ] 最新のmainブランチをpull
- [ ] 新しいフィーチャーブランチを作成
- [ ] `npm install`を実行

### 開発中
- [ ] こまめにコミット（小さな単位で）
- [ ] TypeScriptエラーがないことを確認
- [ ] `npm run dev`で動作確認

### デプロイ前
- [ ] すべての変更をコミット
- [ ] `./scripts/pre-deploy-check.sh`を実行
- [ ] ローカルでビルドテスト
- [ ] 環境変数の確認

### デプロイ時
- [ ] `./scripts/safe-deploy.sh`を使用
- [ ] Vercelダッシュボードでビルド状況を監視
- [ ] デプロイ後に本番環境で動作確認

## 🔧 トラブルシューティング

### npm installエラー
```bash
# node_modulesをクリーンアップ
rm -rf node_modules package-lock.json
npm install
```

### Vercelビルドエラー
1. Vercelのビルドログを確認
2. ローカルで同じコマンドを実行
3. 環境変数の設定を確認

### TypeScriptエラー
```bash
# 詳細なエラーを表示
npx tsc --noEmit --pretty
```

## 🎯 ベストプラクティス

1. **小さな変更を頻繁にデプロイ**
   - 大きな変更は問題の特定が困難

2. **フィーチャーブランチの活用**
   - mainブランチへの直接プッシュを避ける

3. **ローカルテストの徹底**
   - プッシュ前に必ずローカルで確認

4. **環境変数の管理**
   - `.env.example`を最新に保つ
   - 本番環境の変数はVercelで管理

5. **依存関係の整理**
   - 定期的に`npx depcheck`を実行
   - 不要な依存関係は削除

## 📞 サポート

問題が解決しない場合:
1. エラーメッセージを詳細に記録
2. `git log --oneline -10`で最近のコミットを確認
3. Vercelのビルドログを保存
4. 必要に応じてロールバック

---

このガイドに従うことで、デプロイエラーを大幅に削減できます。
安全で確実なデプロイを心がけましょう！ 🚀