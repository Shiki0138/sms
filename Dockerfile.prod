# ğŸ³ ç¾å®¹å®¤çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - æœ¬ç•ªç”¨Dockerãƒ•ã‚¡ã‚¤ãƒ«

# ===== Multi-stage Build for Production =====

# Stage 1: Base image with common dependencies
FROM node:18-alpine AS base
LABEL maintainer="Team C - QA & Deploy <qa@salon-system.com>"
LABEL description="ç¾å®¹å®¤çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - æœ¬ç•ªç’°å¢ƒç”¨"

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
RUN addgroup -g 1001 -S salon && \
    adduser -S salon -u 1001 -G salon

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè¨­å®š
WORKDIR /app

# ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apk add --no-cache \
    dumb-init \
    tzdata \
    curl \
    && rm -rf /var/cache/apk/*

# ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è¨­å®š
ENV TZ=Asia/Tokyo

# Stage 2: Backend build
FROM base AS backend-builder

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚½ãƒ¼ã‚¹ã‚³ãƒ”ãƒ¼
COPY backend/package*.json ./backend/
COPY backend/prisma ./backend/prisma/

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç”¨ï¼‰
RUN cd backend && \
    npm ci --only=production && \
    npm cache clean --force

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚½ãƒ¼ã‚¹ã‚³ãƒ”ãƒ¼ãƒ»ãƒ“ãƒ«ãƒ‰
COPY backend/ ./backend/
RUN cd backend && \
    npm run build && \
    npx prisma generate

# Stage 3: Frontend build
FROM base AS frontend-builder

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY frontend/package*.json ./frontend/
RUN cd frontend && \
    npm ci && \
    npm cache clean --force

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚½ãƒ¼ã‚¹ã‚³ãƒ”ãƒ¼ãƒ»ãƒ“ãƒ«ãƒ‰
COPY frontend/ ./frontend/
RUN cd frontend && \
    npm run build

# Stage 4: Production runtime
FROM node:18-alpine AS production

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
RUN addgroup -g 1001 -S salon && \
    adduser -S salon -u 1001 -G salon

# å¿…è¦ãªã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
RUN apk add --no-cache \
    dumb-init \
    tzdata \
    curl \
    nginx \
    supervisor \
    && rm -rf /var/cache/apk/*

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
WORKDIR /app

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æˆæœç‰©ã‚³ãƒ”ãƒ¼
COPY --from=backend-builder --chown=salon:salon /app/backend/dist ./backend/dist
COPY --from=backend-builder --chown=salon:salon /app/backend/node_modules ./backend/node_modules
COPY --from=backend-builder --chown=salon:salon /app/backend/prisma ./backend/prisma
COPY --from=backend-builder --chown=salon:salon /app/backend/package.json ./backend/

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æˆæœç‰©ã‚³ãƒ”ãƒ¼
COPY --from=frontend-builder --chown=salon:salon /app/frontend/dist ./frontend/dist

# Nginxè¨­å®š
COPY docker/nginx.conf /etc/nginx/nginx.conf
COPY docker/supervisor.conf /etc/supervisor/conf.d/supervisord.conf

# ç’°å¢ƒå¤‰æ•°è¨­å®š
ENV NODE_ENV=production
ENV PORT=4002
ENV FRONTEND_PORT=80

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
COPY docker/healthcheck.js /app/healthcheck.js
RUN chmod +x /app/healthcheck.js

# ãƒãƒ¼ãƒˆå…¬é–‹
EXPOSE 80 4002

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è¨­å®š
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD node /app/healthcheck.js

# æ¨©é™è¨­å®š
RUN chown -R salon:salon /app
USER salon

# ãƒ—ãƒ­ã‚»ã‚¹èµ·å‹•ï¼ˆSupervisorä½¿ç”¨ï¼‰
ENTRYPOINT ["/usr/bin/dumb-init", "--"]
CMD ["supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]

# ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
LABEL version="1.0.0"
LABEL release="production"
LABEL org.opencontainers.image.title="ç¾å®¹å®¤çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ "
LABEL org.opencontainers.image.description="AIæ­è¼‰ã®æ¬¡ä¸–ä»£ç¾å®¹å®¤ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ "
LABEL org.opencontainers.image.vendor="Salon System Team"
LABEL org.opencontainers.image.licenses="MIT"