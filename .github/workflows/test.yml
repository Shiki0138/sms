name: ðŸ§ª åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ

on:
  push:
    branches: [ main, master, develop, team-* ]
  pull_request:
    branches: [ main, master, develop ]

env:
  NODE_VERSION: '18'
  FORCE_COLOR: 1

jobs:
  # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãƒ»çµ±åˆãƒ†ã‚¹ãƒˆ
  test-backend:
    name: ðŸ”§ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: salon_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: ðŸ“¥ ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ðŸ“¦ Node.js ${{ env.NODE_VERSION }} ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ”§ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        npm ci
        cd backend && npm ci

    - name: ðŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æº–å‚™
      run: |
        cd backend
        cp .env.example .env.test
        npx prisma generate
        npx prisma db push
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/salon_test

    - name: ðŸ§ª ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: npx jest --config jest.simple.config.js --coverage --maxWorkers=2
      env:
        NODE_OPTIONS: "--max-old-space-size=4096"
        NODE_ENV: test
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/salon_test

    - name: ðŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        file: ./coverage/lcov.info
        flags: backend
        name: backend-coverage

  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
  test-frontend:
    name: ðŸŽ¨ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ðŸ“¦ Node.js ${{ env.NODE_VERSION }} ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ”§ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        npm ci
        cd frontend && npm ci

    - name: ðŸ§ª ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        cd frontend
        npm run test:unit
      env:
        NODE_ENV: test

    - name: ðŸ—ï¸ ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
      run: |
        cd frontend
        npm run build

  # E2Eãƒ†ã‚¹ãƒˆ
  test-e2e:
    name: ðŸŒ E2Eãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]

    steps:
    - name: ðŸ“¥ ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ðŸ“¦ Node.js ${{ env.NODE_VERSION }} ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ”§ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        npm ci
        cd backend && npm ci
        cd ../frontend && npm ci

    - name: ðŸŽ­ Playwright ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npx playwright install --with-deps

    - name: ðŸš€ ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      run: |
        cd backend && npm start &
        cd frontend && npm start &
        sleep 30  # ã‚µãƒ¼ãƒãƒ¼èµ·å‹•å¾…æ©Ÿ
      env:
        NODE_ENV: test
        DATABASE_URL: file:./test.db

    - name: ðŸ§ª E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: npx playwright test
      env:
        NODE_ENV: test

    - name: ðŸ“Š E2Eãƒ†ã‚¹ãƒˆçµæžœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ
  security-scan:
    name: ðŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ðŸ” Snyk ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high

    - name: ðŸ§ª ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: npx jest tests/security --testTimeout=60000
      env:
        NODE_ENV: test

  # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
  performance-test:
    name: âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    needs: [test-backend]

    steps:
    - name: ðŸ“¥ ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ðŸ“¦ Node.js ${{ env.NODE_VERSION }} ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ”§ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        npm ci
        cd backend && npm ci
        npm install -g artillery

    - name: ðŸš€ ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      run: |
        cd backend && npm start &
        sleep 20  # ã‚µãƒ¼ãƒãƒ¼èµ·å‹•å¾…æ©Ÿ
      env:
        NODE_ENV: test
        DATABASE_URL: file:./test.db

    - name: âš¡ è² è·ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: artillery run tests/performance/load/basic-health-check.js
      continue-on-error: true

  # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
  code-quality:
    name: ðŸ“ ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ðŸ“¦ Node.js ${{ env.NODE_VERSION }} ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ”§ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        npm ci
        cd backend && npm ci
        cd ../frontend && npm ci

    - name: ðŸ§¹ ESLintå®Ÿè¡Œ
      run: |
        cd backend && npm run lint
        cd ../frontend && npm run lint

    - name: ðŸ” TypeScriptåž‹ãƒã‚§ãƒƒã‚¯
      run: |
        cd backend && npm run type-check
        cd ../frontend && npm run type-check

  # å“è³ªã‚²ãƒ¼ãƒˆ
  quality-gate:
    name: ðŸšª å“è³ªã‚²ãƒ¼ãƒˆ
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend, test-e2e, security-scan, performance-test, code-quality]
    if: always()

    steps:
    - name: ðŸ“Š å“è³ªã‚²ãƒ¼ãƒˆåˆ¤å®š
      run: |
        echo "ðŸŽ¯ å“è³ªã‚²ãƒ¼ãƒˆçµæžœç¢ºèª"
        if [[ "${{ needs.test-backend.result }}" == "success" && 
              "${{ needs.test-frontend.result }}" == "success" && 
              "${{ needs.security-scan.result }}" == "success" && 
              "${{ needs.code-quality.result }}" == "success" ]]; then
          echo "âœ… å“è³ªã‚²ãƒ¼ãƒˆ: PASS"
          echo "ðŸŽ‰ ãƒªãƒªãƒ¼ã‚¹æº–å‚™å®Œäº†ï¼"
        else
          echo "âŒ å“è³ªã‚²ãƒ¼ãƒˆ: FAIL"
          echo "âš ï¸ å“è³ªåŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“"
          exit 1
        fi

    - name: ðŸ“‹ ãƒ†ã‚¹ãƒˆçµæžœã‚µãƒžãƒªãƒ¼
      run: |
        echo "## ðŸ§ª ãƒ†ã‚¹ãƒˆçµæžœã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
        echo "| ãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒ— | çµæžœ |" >> $GITHUB_STEP_SUMMARY
        echo "|-------------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ | ${{ needs.test-backend.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ | ${{ needs.test-frontend.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| E2E | ${{ needs.test-e2e.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ | ${{ needs.security-scan.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ | ${{ needs.performance-test.result == 'success' && 'âœ… PASS' || 'âš ï¸ WARNING' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ã‚³ãƒ¼ãƒ‰å“è³ª | ${{ needs.code-quality.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> $GITHUB_STEP_SUMMARY