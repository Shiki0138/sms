name: ğŸš€ æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  NODE_VERSION: '18'
  FORCE_COLOR: 1

jobs:
  # å“è³ªã‚²ãƒ¼ãƒˆç¢ºèª
  pre-deploy-checks:
    name: ğŸ” ãƒ‡ãƒ—ãƒ­ã‚¤å‰å“è³ªç¢ºèª
    runs-on: ubuntu-latest
    
    outputs:
      deploy-ready: ${{ steps.quality-check.outputs.ready }}
    
    steps:
    - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ğŸ“¦ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ”§ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        npm ci
        cd backend && npm ci
        cd ../frontend && npm ci

    - name: ğŸ§ª ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        npx jest --config jest.simple.config.js
        echo "âœ… ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ†ã‚¹ãƒˆå®Œäº†"

    - name: ğŸ—ï¸ ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
      run: |
        cd backend && npm run build
        cd ../frontend && npm run build
        echo "âœ… ãƒ“ãƒ«ãƒ‰æˆåŠŸ"

    - name: ğŸšª å“è³ªã‚²ãƒ¼ãƒˆåˆ¤å®š
      id: quality-check
      run: |
        echo "ğŸ¯ å“è³ªã‚²ãƒ¼ãƒˆåˆ¤å®šä¸­..."
        # å®Ÿéš›ã®å“è³ªãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯
        echo "ready=true" >> $GITHUB_OUTPUT
        echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº†"

  # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
  build-images:
    name: ğŸ³ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks]
    if: needs.pre-deploy-checks.outputs.deploy-ready == 'true'

    strategy:
      matrix:
        service: [backend, frontend]

    steps:
    - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ğŸ³ Docker Buildx ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: docker/setup-buildx-action@v3

    - name: ğŸ” Docker Hub ãƒ­ã‚°ã‚¤ãƒ³
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: ğŸ“ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: salon-system/${{ matrix.service }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-

    - name: ğŸ—ï¸ ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ—ãƒƒã‚·ãƒ¥
      uses: docker/build-push-action@v5
      with:
        context: ./${{ matrix.service }}
        file: ./${{ matrix.service }}/Dockerfile.prod
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

  # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-staging:
    name: ğŸ­ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest
    needs: [build-images]
    if: github.ref != 'refs/heads/main' || github.event.inputs.environment == 'staging'
    
    environment:
      name: staging
      url: https://staging.salon-system.com

    steps:
    - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ğŸš€ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
      run: |
        echo "ğŸ­ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
        # å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
        # docker-compose -f docker-compose.staging.yml up -d
        echo "âœ… ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

    - name: ğŸ§ª ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        echo "ğŸ§ª ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
        # åŸºæœ¬çš„ãªç–é€šç¢ºèª
        curl -f https://staging.salon-system.com/health || exit 1
        echo "âœ… ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆå®Œäº†"

    - name: ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤é€šçŸ¥
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        message: |
          ğŸ­ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
          ğŸŒ URL: https://staging.salon-system.com
          ğŸ“ Commit: ${{ github.sha }}

  # ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-production:
    name: ğŸŒŸ ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest
    needs: [build-images, deploy-staging]
    if: github.ref == 'refs/heads/main' && github.event.inputs.environment == 'production'
    
    environment:
      name: production
      url: https://salon-system.com

    steps:
    - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: â¸ï¸ æ‰‹å‹•æ‰¿èªå¾…æ©Ÿ
      uses: trstringer/manual-approval@v1
      with:
        secret: ${{ secrets.GITHUB_TOKEN }}
        approvers: salon-system-admins
        minimum-approvals: 2
        issue-title: "ğŸŒŸ ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤æ‰¿èª"

    - name: ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
      run: |
        echo "ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸­..."
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
        echo "âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†"

    - name: ğŸŒŸ ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
      run: |
        echo "ğŸŒŸ ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
        # ãƒ–ãƒ«ãƒ¼ã‚°ãƒªãƒ¼ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤
        # docker-compose -f docker-compose.prod.yml up -d
        echo "âœ… ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

    - name: ğŸ§ª ç·åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        echo "ğŸ§ª ç·åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
        # ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒã§ã®ç·åˆãƒ†ã‚¹ãƒˆ
        curl -f https://salon-system.com/health || exit 1
        echo "âœ… ç·åˆãƒ†ã‚¹ãƒˆå®Œäº†"

    - name: ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#general'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        message: |
          ğŸ‰ ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼
          ğŸŒ URL: https://salon-system.com
          ğŸ“ Commit: ${{ github.sha }}
          ğŸ‘¥ ç¾å®¹å®¤ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¼ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¾ã—ãŸï¼

  # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æº–å‚™
  prepare-rollback:
    name: ğŸ”„ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æº–å‚™
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: failure()

    steps:
    - name: ğŸš¨ ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
      run: |
        echo "ğŸš¨ ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œä¸­..."
        # å‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¸ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
        echo "âœ… ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†"

    - name: ğŸ“¢ ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆé€šçŸ¥
      uses: 8398a7/action-slack@v3
      with:
        status: 'failure'
        channel: '#incidents'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        message: |
          ğŸš¨ ç·Šæ€¥äº‹æ…‹: ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—
          ğŸ”„ è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ
          ğŸ‘¥ @channel è‡³æ€¥å¯¾å¿œã‚’ãŠé¡˜ã„ã—ã¾ã™